/*! jshint debug: true, expr: true */

/* 2018-07-11 TC moOde 4.2
 * - css vars, other css for newui v2
 * - adj method for dominance
 * - clean up tabbing
 * 2018-09-27 TC moOde 4.3
 * - minor fixes
 * 2018-12-09 TC moOde 4.4
 * - improvements for btnBarFix()
 * 2019-05-30 TC moOde 5.3
 * - Add parseInt to getYiq()
 *
 */

!function(a){function r(a,r){var e=a.split(","),n=0>r?0:255,t=0>r?-1*r:r,o=parseInt(e[0].slice(4)),c=parseInt(e[1]),s=parseInt(e[2]);return"rgb("+(Math.round((n-o)*t)+o)+","+(Math.round((n-c)*t)+c)+","+(Math.round((n-s)*t)+s)+")"}function e(a,r,e){var n=a.split(","),t=r.split(","),o=parseInt(n[0].slice(4)),c=parseInt(n[1]),s=parseInt(n[2]);return"rgb("+(Math.round((parseInt(t[0].slice(4))-o)*e)+o)+","+(Math.round((parseInt(t[1])-c)*e)+c)+","+(Math.round((parseInt(t[2])-s)*e)+s)+")"}var n="data-ab-color",t="data-ab-parent",o="data-ab-css-background",c="ab-color-found",s="blend",i={selector:"[data-adaptive-background]",parent:"#playback-panel",exclude:["rgb(0,0,0)","rgb(255,255,255)"],shadeVariation:"blend",shadePercentage:.15,shadeColors:{light:"rgb(128,128,128)",dark:"rgb(224,224,224)"},normalizeTextColor:!0,normalizedTextColors:{light:"#eee",dark:"#333"},lumaClasses:{light:"ab-light",dark:"ab-dark"},transparent:null};!function(a,r){"use strict";var r=function(){return document.createElement("canvas").getContext("2d")},e=function(a,e){var n=new Image,t=a.src||a;"data:"!==t.substring(0,5)&&(n.crossOrigin="Anonymous"),n.onerror=function(){adaptMcolor=themeMcolor,adaptMback=themeMback,adaptColor=themeColor,adaptBack=themeBack},n.onload=function(){var a=r("2d");a.drawImage(n,0,0);var t=a.getImageData(0,0,n.width,n.height);e&&e(t.data)},n.src=t},n=function(a){return["rgb(",a,")"].join("")},t=function(a){return a.map(function(a){return n(a.name)})},o=5,c=10,s={};s.colors=function(a,r){r=r||{};var s=r.exclude||[],i=r.paletteSize||c;e(a,function(e){for(var c=a.width*a.height||e.length,l={},d="",u=[],p={dominant:{name:"",count:0},palette:Array.apply(null,new Array(i)).map(Boolean).map(function(){return{name:"0,0,0",count:0}})},g=0;c>g;){if(u[0]=e[g],u[1]=e[g+1],u[2]=e[g+2],d=u.join(","),l[d]=d in l?l[d]+1:1,-1===s.indexOf(n(d))){var m=l[d];m>p.dominant.count?(p.dominant.name=d,p.dominant.count=m):p.palette.some(function(a){return m>a.count?(a.name=d,a.count=m,!0):void 0})}g+=4*o}if(r.success){var h=t(p.palette);"rgb(0,0,0)"==h[1]&&(h[0]=n(p.dominant.name)),"rgb(255,255,255)"==h[0]&&(h[0]=h[1]);var b=rgbToHsl(h[0]),f=rgbToHsl(h[1]),v=rgbToHsl(n(p.dominant.name)),k=0,I=0;b[2]>f[2]?(k=0,I=1):(k=1,I=0),v[2]+.2>b[2]&&v[2]<".98"&&(h[0]=n(p.dominant.name),k=0,I=1),"rgb(255,255,255)"==n(p.dominant.name)&&"rgb(0,0,0)"==h[1]&&(h[0]=n(p.dominant.name),k=0,I=1),v[2]>.98&&(k=0,I=1),r.success({dominant:h[k],secondary:h[I],palette:h})}})},a.RGBaster=a.RGBaster||s}(window),a.adaptiveBackground={run:function(l){var d=a.extend({},i,l);abfound="false",a(d.selector).each(function(){var i=a(this),l=function(){if("PICTURE"==i[0].tagName){var a=i[0].children;for(var r in a)if("IMG"==a[r].tagName){var e=a[r];break}e.currentSrc&&(e=e.currentSrc)}else var e=p()?g():i[0];RGBaster.colors(e,{paletteSize:20,exclude:d.exclude,success:function(a){i.attr(n,a.dominant),i.trigger(c,{color:a.dominant,palette:a.palette})}})},u=function(a){var r=a.match(/\d+/g);return parseInt((299*r[0]+587*r[1]+114*r[2])/1e3)},p=function(){var a=i.attr(o);return"undefined"!=typeof a&&a!==!1},g=function(){var a=i.css("background-image"),r=/\(([^)]+)\)/,e=r.exec(a)[1].replace(/"/g,"");return e},m=function(a){return"rgb()"==a&&(a="rgb(0,0,0)"),1==d.shadeVariation?u(a)<=128?r(a,d.shadePercentage):r(a,-d.shadePercentage,d.shadePercentage):d.shadeVariation==s?u(a)>=128?e(a,d.shadeColors.dark,d.shadePercentage):e(a,d.shadeColors.light,d.shadePercentage):void 0};i.on(c,function(r,e){var n;if(n=d.parent&&i.parents(d.parent).length?i.parents(d.parent):i.attr(t)&&i.parents(i.attr(t)).length?i.parents(i.attr(t)):p()?i:d.parent?i.parents(d.parent):i.parent(),d.shadeVariation&&(e.color=m(e.color)),a.isNumeric(d.transparent)&&null!=d.transparent&&d.transparent>=.01&&d.transparent<=.99){var o=e.color,c=o.replace("rgb","rgba"),s=c.replace(")",", "+d.transparent+")");n.css({backgroundColor:s})}var l=rgbToHsl(e.color),g=l[2],h=e.color;.1>g?l[2]=g+.03:.45>g&&g>.35&&(l[2]=g-.05);var b=hslToRgb(l),h="rgba(",f="rgba(";abFound="true",h=h.concat(b[0],",",b[1],",",b[2],","+SESSION.json.alphablend+")"),f=f.concat(b[0],",",b[1],",",b[2],","+themeOp+")"),e.color=h,adaptBack=h;var b=hslToRgb(l),v="rgba(";v=v.concat(b[0],",",b[1],",",b[2],",",themeOp,")"),adaptMback=v,adaptMhalf="rgba(".concat(b[0],",",b[1],",",b[2],",0.5)");var k=function(a){return u(a)>=128?d.normalizedTextColors.dark:d.normalizedTextColors.light};d.normalizeTextColor&&(adaptMcolor=k(e.color),adaptColor=adaptMcolor,"Yes"==SESSION.json.adaptive&&setColors()),d.success&&d.success(i,e)}),l()})}}}(jQuery);
