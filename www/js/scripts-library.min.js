/*!
 * moOde audio player (C) 2014 Tim Curtis
 * http://moodeaudio.org
 *
 * tsunamp player ui (C) 2013 Andrea Coiutti & Simone De Gregori
 * http://www.tsunamp.com
 *
 * This Program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3, or (at your option)
 * any later version.
 *
 * This Program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 *
 * 2020-07-09 TC moOde 6.6.0
 *
 * This is the @chris-rudmin rewrite of the library group/filter routines
 * including modifications to all dependant functions and event handlers.
 * Refer to https://github.com/moode-player/moode/pull/16 for more info.
 *
 */
function loadLibrary(){GLOBAL.libLoading=!0,"tag"!=currentView&&"album"!=currentView||notify("library_loading"),$.post("command/moode.php?cmd=loadlib",function(e){$("#lib-content").show(),renderLibrary(e),GLOBAL.libRendered=!0,GLOBAL.libLoading=!1},"json")}function renderLibrary(e){groupLib(e),filterLib(),LIB.totalSongs=allSongs.length,renderGenres()}function reduceGenres(e,t){var r=t.genre.toLowerCase();return e[r]||(e[r]=[],e[r].genre=t.genre),e[r].push(t),e}function reduceArtists(e,t){var r=(t.album_artist||t.artist).toLowerCase();return e[r]||(e[r]=[],e[r].artist=t.album_artist||t.artist),e[r].push(t),e}function reduceAlbums(e,t){var r=t.key;return e[r]||(e[r]=[]),e[r].push(t),e}function findAlbumProp(e,t){var r=e.find(function(e){return e[t]});return r&&r[t]}function getLastModified(e){var t=e.map(function(e){return new Date(e.last_modified)});return new Date(Math.max.apply(null,t))}function getYear(e){var t=e.map(function(e){return e.year});return Math.max.apply(null,t)}function groupLib(e){allSongs=e.map(function(e){var t=e;return t.key=keyAlbum(e),t}),allGenres=Object.values(allSongs.reduce(reduceGenres,{})).map(function(e){return e.genre}),allGenres.sort(),allAlbums=Object.values(allSongs.reduce(reduceAlbums,{})).map(function(e){var t=findAlbumProp(e,"file"),r=$.md5(t.substring(0,t.lastIndexOf("/"))),l=findAlbumProp(e,"artist"),i=findAlbumProp(e,"album_artist"),s=getYear(e);return{last_modified:getLastModified(e),year:s,album:findAlbumProp(e,"album"),genre:findAlbumProp(e,"genre"),all_genres:Object.keys(e.reduce(reduceGenres,{})),artist:i||l,imgurl:"/imagesw/thmcache/"+encodeURIComponent(r)+".jpg",encoded_at:findAlbumProp(e,"encoded_at")}}),allAlbumCovers=allAlbums.slice();try{var t=new Intl.Collator(void 0,{numeric:!0,sensitivity:"base"});switch(allSongs.sort(function(e,r){return t.compare(removeArticles(e.album_artist||e.artist),removeArticles(r.album_artist||r.artist))}),SESSION.json.library_albumview_sort){case"Album":allAlbumCovers.sort(function(e,r){return t.compare(removeArticles(e.album),removeArticles(r.album))});break;case"Artist":allAlbumCovers.sort(function(e,r){return t.compare(removeArticles(e.artist),removeArticles(r.artist))||t.compare(removeArticles(e.album),removeArticles(r.album))});break;case"Artist/Year":allAlbumCovers.sort(function(e,r){return t.compare(removeArticles(e.artist),removeArticles(r.artist))||t.compare(e.year,r.year)});break;case"Year":allAlbumCovers.sort(function(e,r){return t.compare(e.year,r.year)||t.compare(removeArticles(e.album),removeArticles(r.album))})}switch(SESSION.json.library_tagview_sort){case"Album":case"Album/Year":allAlbums.sort(function(e,r){return t.compare(removeArticles(e.album),removeArticles(r.album))});break;case"Artist":allAlbums.sort(function(e,r){return t.compare(removeArticles(e.artist),removeArticles(r.artist))||t.compare(removeArticles(e.album),removeArticles(r.album))});break;case"Artist/Year":allAlbums.sort(function(e,r){return t.compare(removeArticles(e.artist),removeArticles(r.artist))||t.compare(e.year,r.year)});break;case"Year":allAlbums.sort(function(e,r){return t.compare(e.year,r.year)||t.compare(removeArticles(e.album),removeArticles(r.album))})}}catch(r){switch(allSongs.sort(function(e,t){return e=removeArticles((e.album_artist||e.artist).toLowerCase()),t=removeArticles((t.album_artist||t.artist).toLowerCase()),e>t?1:t>e?-1:0}),SESSION.json.library_albumview_sort){case"Album":allAlbumCovers.sort(function(e,t){return e=removeArticles(e.album.toLowerCase()),t=removeArticles(t.album.toLowerCase()),e>t?1:t>e?-1:0});break;case"Artist":allAlbumCovers.sort(function(e,t){var r=removeArticles(e.artist).toLowerCase(),l=removeArticles(t.artist).toLowerCase(),i=removeArticles(e.album).toLowerCase(),s=removeArticles(t.album).toLowerCase();return r>l?1:l>r?-1:i>s?1:s>i?-1:0});break;case"Artist/Year":allAlbumCovers.sort(function(e,t){var r=removeArticles(e.artist).toLowerCase(),l=removeArticles(t.artist).toLowerCase(),i=e.year,s=t.year;return r>l?1:l>r?-1:i>s?1:s>i?-1:0});break;case"Year":allAlbumCovers.sort(function(e,t){var r=e.year,l=t.year,i=removeArticles(e.album).toLowerCase(),s=removeArticles(t.album).toLowerCase();return r>l?1:l>r?-1:i>s?1:s>i?-1:0})}switch(SESSION.json.library_tagview_sort){case"Album":case"Album/Year":allAlbums.sort(function(e,t){return e=removeArticles(e.album.toLowerCase()),t=removeArticles(t.album.toLowerCase()),e>t?1:t>e?-1:0});break;case"Artist":allAlbums.sort(function(e,t){var r=removeArticles(e.artist).toLowerCase(),l=removeArticles(t.artist).toLowerCase(),i=removeArticles(e.album).toLowerCase(),s=removeArticles(t.album).toLowerCase();return r>l?1:l>r?-1:i>s?1:s>i?-1:0});break;case"Artist/Year":allAlbums.sort(function(e,t){var r=removeArticles(e.artist).toLowerCase(),l=removeArticles(t.artist).toLowerCase(),i=e.year,s=t.year;return r>l?1:l>r?-1:i>s?1:s>i?-1:0});break;case"Year":allAlbums.sort(function(e,t){var r=e.year,l=t.year,i=removeArticles(e.album).toLowerCase(),s=removeArticles(t.album).toLowerCase();return r>l?1:l>r?-1:i>s?1:s>i?-1:0})}}}function filterByGenre(e){var t=e.genre.toLowerCase();return LIB.filters.genres.find(function(e){return t===e.toLowerCase()})}function filterByAllGenres(e){return LIB.filters.genres.find(function(t){return e.all_genres.includes(t.toLowerCase())})}function filterByArtist(e){var t=e.artist.toLowerCase(),r=e.album_artist&&e.album_artist.toLowerCase();return LIB.filters.artists.find(function(e){var l=e.toLowerCase();return LIB.filters.artists==SESSION.json.library_comp_id?t===l||r===l:r!=SESSION.json.library_comp_id.toLowerCase()?t===l||r===l:void 0})}function filterByAlbum(e){return LIB.filters.albums.includes(e.key)}function filterAlbumsByDate(e){return LIB.currentDate.getTime()-e.last_modified.getTime()<=parseInt(SESSION.json.library_recently_added)}function filterSongsByDate(e){return itemDateObj=new Date(e.last_modified),LIB.currentDate.getTime()-itemDateObj.getTime()<=parseInt(SESSION.json.library_recently_added)}function filterByYear(e){return e.year==LIB.filters.year[0]?a=!0:e.year>=LIB.filters.year[0]&&e.year<=LIB.filters.year[1]?a=!0:a=!1,a}function filterArtists(){var e=allSongs;LIB.filters.genres.length&&(e=e.filter(filterByGenre)),filteredArtists=Object.values(e.reduce(reduceArtists,{})).map(function(e){return e.artist})}function filterAlbums(){if(filteredAlbums=allAlbums,filteredAlbumCovers=allAlbumCovers,LIB.filters.genres.length&&(filteredAlbums=filteredAlbums.filter(filterByAllGenres),filteredAlbumCovers=filteredAlbumCovers.filter(filterByAllGenres)),LIB.filters.artists.length&&(filteredAlbums=filteredAlbums.filter(filterByArtist),filteredAlbumCovers=filteredAlbumCovers.filter(filterByArtist)),LIB.recentlyAddedClicked){LIB.currentDate=new Date,filteredAlbums=filteredAlbums.filter(filterAlbumsByDate),filteredAlbumCovers=filteredAlbumCovers.filter(filterAlbumsByDate);try{var e=new Intl.Collator(void 0,{numeric:!0,sensitivity:"base"});filteredAlbums.sort(function(t,r){return e.compare(r.last_modified.getTime(),t.last_modified.getTime())}),filteredAlbumCovers.sort(function(t,r){return e.compare(r.last_modified.getTime(),t.last_modified.getTime())})}catch(t){filteredAlbums.sort(function(e,t){return e=e.last_modified.getTime(),t=t.last_modified.getTime(),t>e?1:e>t?-1:0}),filteredAlbumCovers.sort(function(e,t){return e=e.last_modified.getTime(),t=t.last_modified.getTime(),t>e?1:e>t?-1:0})}}LIB.filters.year.length&&(filteredAlbums=filteredAlbums.filter(filterByYear),filteredAlbumCovers=filteredAlbumCovers.filter(filterByYear))}function filterSongs(){filteredSongs=allSongs,LIB.filters.genres.length&&(filteredSongs=filteredSongs.filter(filterByGenre)),LIB.filters.artists.length&&(filteredSongs=filteredSongs.filter(filterByArtist)),LIB.filters.albums.length&&(filteredSongs=filteredSongs.filter(filterByAlbum)),LIB.recentlyAddedClicked&&(filteredSongs=filteredSongs.filter(filterSongsByDate)),LIB.filters.year.length&&(filteredSongs=filteredSongs.filter(filterByYear))}function filterLib(){filteredSongsDisc.length=0,filterArtists(),filterAlbums(),filterSongs()}function removeArticles(e){return"None"!=SESSION.json.library_ignore_articles?e.replace(GLOBAL.regExIgnoreArticles,"$2"):e}function keyAlbum(e){return e.album.toLowerCase()+"@"+(e.album_artist||e.artist).toLowerCase()}function parseSongTime(e){var t=parseInt(e);return isNaN(t)?0:t}function makeCoverUrl(e){return"/coverart.php/"+encodeURIComponent(e)}function clickedLibItem(e,t,r,l){void 0==t?r.length=0:e.ctrlKey?(currentIndex=r.indexOf(t),currentIndex>=0?r.splice(currentIndex,1):r.push(t)):(r.length=0,r.push(t)),filterLib(),"Album/Year"==SESSION.json.library_tagview_sort&&1==LIB.artistClicked&&filteredAlbums.sort(function(e,t){return parseInt(e.year)-parseInt(t.year)}),l()}var LIB={albumClicked:!1,recentlyAddedClicked:!1,currentDate:null,totalTime:0,totalSongs:0,artistClicked:"",filters:{artists:[],genres:[],albums:[],year:[]}},allGenres=[],allAlbums=[],allSongs=[],allAlbumCovers=[],filteredGenres=[],filteredArtists=[],filteredAlbums=[],filteredSongs=[],filteredSongsDisc=[],filteredAlbumCovers=[];Object.values||Object.defineProperty(Object,"values",{configurable:!0,enumerable:!1,value:function(e){return Object.keys(e).map(function(t){return e[t]})},writable:!0});var renderGenres=function(){for(var e="",t=0;t<allGenres.length;t++)e+='<li class="lib-entry'+(LIB.filters.genres.indexOf(allGenres[t])>=0?" active":"")+'">'+allGenres[t]+"</li>";$("#genresList").html(e),-2==UI.libPos[0]&&$("#lib-genre").scrollTo(0,200),renderArtists()},renderArtists=function(){for(var e="",t=0;t<filteredArtists.length;t++)e+='<li class="lib-entry'+(LIB.filters.artists.indexOf(filteredArtists[t])>=0||1==filteredArtists.length?" active":"")+'">'+filteredArtists[t]+"</li>";$("#artistsList").html(e),-2==UI.libPos[0]&&$("#lib-artist").scrollTo(0,200),renderAlbums()},renderAlbums=function(){var e="",t="",r="",l="";if($("#lib-album-filter").val(""),GLOBAL.nativeLazyLoad)var i='<img loading="lazy" src="',s=i;else var i='<img class="lazy-tagview" data-original="',s='<img class="lazy-albumview" data-original="';for(var a=parseInt(SESSION.json.library_encoded_at),o="",n="",d="",m="",c="",b="",u=0;u<filteredAlbums.length;u++){if(r=filteredAlbums[u].year?"("+filteredAlbums[u].year+")":"",l=filteredAlbumCovers[u].year?"("+filteredAlbumCovers[u].year+")":"",9!=a)var o=1==a&&"h"==filteredAlbums[u].encoded_at.split(",")[1]?'<div class="encoded-at-hdonly-tagview">HD</div>':"",n=1>=a?'<div class="encoded-at-notvisible">'+filteredAlbums[u].encoded_at.split(",")[0]+"</div>":"",f=filteredAlbumCovers[u].encoded_at.split(","),d=1>=a?'<div class="encoded-at-notvisible">'+filteredAlbumCovers[u].encoded_at.split(",")[0]+"</div>":"",m=1==a&&"h"==f[1]?'<div class="encoded-at-hdonly">HD</div>':"",c=2==a?'<div class="encoded-at-text">'+f[0]+"</div>":"",b=3==a?'<div class="encoded-at-badge">'+f[0]+"</div>":"";e+="Yes"==SESSION.json.library_tagview_covers?'<li class="lib-entry">'+i+filteredAlbums[u].imgurl+'">'+o+'<div class="tag-cover-text"><span class="album-name-art">'+filteredAlbums[u].album+'</span><span class="artist-name-art">'+filteredAlbums[u].artist+'</span><span class="album-year">'+r+"</span></div>"+n+"</li>":'<li class="lib-entry no-tagview-covers"><span class="album-name">'+filteredAlbums[u].album+'</span><span class="artist-name-art">'+filteredAlbums[u].artist+'</span><span class="album-year">'+r+"</span></li>",t+='<li class="lib-entry">'+s+filteredAlbumCovers[u].imgurl+'"><div class="cover-menu" data-toggle="context" data-target="#context-menu-lib-all"></div>'+m+b+'<span class="album-name">'+filteredAlbumCovers[u].album+'</span><div class="artyear"><span class="artist-name">'+filteredAlbumCovers[u].artist+'</span><span class="album-year">'+l+"</span></div>"+c+d+"</li>"}$("#albumsList").html(e),$("#albumcovers").html(t),1==filteredAlbums.length&&($("#albumsList li").addClass("active"),LIB.albumClicked=!0),"Yes"==SESSION.json.library_ellipsis_limited_text&&$("#library-panel").addClass("limited"),-2==UI.libPos[0]&&($(".tag-view-btn").hasClass("active")?$("#lib-album").scrollTo(0,200):$("#lib-albumcover").scrollTo(0,200)),$(".album-view-btn").hasClass("active")?$("img.lazy-albumview").lazyload({container:$("#lib-albumcover")}):$(".tag-view-btn").hasClass("active")&&"Yes"==SESSION.json.library_tagview_covers&&$("img.lazy-tagview").lazyload({container:$("#lib-album")}),renderSongs()},renderSongs=function(e){var t="",r="",l="",s="",a="";if(LIB.totalTime=0,1==LIB.artistClicked||1==LIB.albumClicked){var o=[];for(i=0;i<filteredAlbums.length;i++)for(j=0;j<filteredSongs.length;j++)filteredSongs[j].album==filteredAlbums[i].album&&o.push(filteredSongs[j]);filteredSongs=o,r="",l="";var n=[];for(i=0;i<filteredSongs.length;i++)filteredSongs[i].album==r&&filteredSongs[i].disc!=l&&(console.log("Multi-disc: "+filteredSongs[i].album),n.push(filteredSongs[i].album)),r=filteredSongs[i].album,l=filteredSongs[i].disc;for(r="",l="",i=0;i<filteredSongs.length;i++){var d=filteredSongs[i].year?filteredSongs[i].year.slice(0,4):" ";filteredSongs[i].album!=r?(s='<div class="lib-album-heading">'+filteredSongs[i].album+"</div>",r=filteredSongs[i].album):s="",-1!=n.indexOf(filteredSongs[i].album)&&(filteredSongs[i].disc!=l?(a='<div id="lib-disc-'+filteredSongs[i].disc+'" class="lib-disc"><a class="btn" href="#notarget" data-toggle="context" data-target="#context-menu-lib-disc">Disc '+filteredSongs[i].disc+"</a></div>",l=filteredSongs[i].disc):a="");var m="Composer tag missing"==filteredSongs[i].composer?"</span>":'<br><span class="songcomposer">'+filteredSongs[i].composer+"</span></span>",c=filteredSongs[i].title==MPD.json.title?" lib-track-highlight":"";t+=s+a+'<li id="lib-song-'+(i+1)+'" class="clearfix"><div class="lib-entry-song"><span class="songtrack'+c+'">'+filteredSongs[i].tracknum+'</span><span class="songname">'+filteredSongs[i].title+'</span><span class="songtime"> '+filteredSongs[i].time_mmss+'</span><span class="songartist"> '+filteredSongs[i].artist+m+'<span class="songyear"> '+d+'</span></div><div class="lib-action"><a class="btn" href="#notarget" data-toggle="context" data-target="#context-menu-lib-item"><i class="fas fa-ellipsis-h"></i></a></div></li>',LIB.totalTime+=parseSongTime(filteredSongs[i].time)}}else for(i=0;i<filteredSongs.length;i++)LIB.totalTime+=parseSongTime(filteredSongs[i].time);if($("#songsList").html(t),filteredAlbums.length>1&&1==LIB.artistClicked&&0==LIB.albumClicked&&$(".lib-album-heading").css("display","block"),l>1&&!filteredSongs[0].album.toLowerCase().includes("[disc")&&$(".lib-disc").css("display","block"),1==filteredAlbums.length||LIB.filters.albums.length||"undefined"!=typeof e)$("#lib-coverart-img").html('<a href="#notarget" data-toggle="context" data-target="#context-menu-lib-all"><img class="lib-coverart" src="'+makeCoverUrl(filteredSongs[0].file)+'" alt="Cover art not found"></a>'),$("#lib-albumname").html(filteredSongs[0].album),u=e&&!UI.libPos[0]?filteredAlbums[UI.libPos[0]].artist:filteredSongs[0].album_artist||filteredSongs[0].artist,$("#lib-artistname").html(u),$("#lib-albumyear").html(filteredSongs[0].year),$("#lib-numtracks").html(filteredSongs.length+(1==filteredSongs.length?" track, ":" tracks, ")+formatTotalTime(LIB.totalTime)),$("#lib-encoded-at").html(filteredSongs[0].encoded_at.split(",")[0]);else{var b=LIB.filters.genres.length?LIB.filters.genres:LIB.filters.artists.length?LIB.filters.artists:"Music Library",u=LIB.filters.genres.length?LIB.filters.artists:"";LIB.filters.artists.length>0?($("#lib-coverart-img").html('<button class="btn" id="tagview-text-cover" data-toggle="context" data-target="#context-menu-lib-all">'+LIB.filters.artists[0]+"</button>"),u=""):LIB.filters.genres.length>0?$("#lib-coverart-img").html('<button class="btn" id="tagview-text-cover" data-toggle="context" data-target="#context-menu-lib-all">'+LIB.filters.genres[0]+"</button>"):$("#lib-coverart-img").html('<button class="btn" id="tagview-text-cover" data-toggle="context" data-target="#context-menu-lib-all">Music Collection</button>'),$("#lib-albumname").html(b),$("#lib-artistname").html(u),$("#lib-albumyear").html(""),$("#lib-numtracks").html(formatNumCommas(filteredAlbums.length)+" albums<br>"+formatNumCommas(filteredSongs.length)+(1==filteredSongs.length?" track<br>":" tracks<br>")+formatTotalTime(LIB.totalTime)),$("#lib-encoded-at").html("")}};$("#genreheader, #menu-header").on("click",function(e){LIB.filters.genres.length=0,LIB.filters.artists.length=0,LIB.filters.albums.length=0,LIB.filters.year.length=0,"tag"!=currentView&&"album"!=currentView||(LIB.artistClicked=!1,LIB.albumClicked=!1,$("#searchResetLib").hide(),showSearchResetLib=!1,"recent"!=GLOBAL.musicScope||GLOBAL.searchLib||(GLOBAL.musicScope="all"),GLOBAL.searchLib="","album"==currentView&&($("#albumcovers .lib-entry").removeClass("active"),$("#bottom-row").css("display",""),$("#lib-albumcover").css("height","100%")),setLibMenuHeader()),"radio"==currentView&&(GLOBAL.searchRadio="",$("#searchResetRa").click(),setLibMenuHeader()),UI.libPos.fill(-2),storeLibPos(UI.libPos),clickedLibItem(e,void 0,LIB.filters.genres,renderGenres)}),$("#artistheader").on("click",".lib-heading",function(e){LIB.artistClicked=!1,LIB.albumClicked=!1,LIB.filters.artists.length=0,LIB.filters.albums.length=0,UI.libPos.fill(-2),storeLibPos(UI.libPos),clickedLibItem(e,void 0,LIB.filters.artists,renderArtists),$("#searchResetLib").hide(),showSearchResetLib=!1,setLibMenuHeader()}),$("#albumheader").on("click",".lib-heading",function(e){LIB.albumClicked=!1,LIB.filters.albums.length=0,UI.libPos[0]=-2,UI.libPos[1]=-2,clickedLibItem(e,void 0,LIB.filters.albums,renderAlbums),storeLibPos(UI.libPos),$("#searchResetLib").hide(),showSearchResetLib=!1}),$("#genresList").on("click",".lib-entry",function(e){var t=$("#genresList .lib-entry").index(this);LIB.artistClicked=!1,LIB.albumClicked=!1,LIB.filters.artists.length=0,LIB.filters.albums.length=0,UI.libPos[0]=-1,storeLibPos(UI.libPos),clickedLibItem(e,allGenres[t],LIB.filters.genres,renderGenres),setLibMenuHeader()}),$("#artistsList").on("click",".lib-entry",function(e){var t=$("#artistsList .lib-entry").index(this);UI.libPos[0]=-1,UI.libPos[2]=t,LIB.filters.albums.length=0,storeLibPos(UI.libPos),LIB.artistClicked=!0,LIB.albumClicked=!1,clickedLibItem(e,filteredArtists[t],LIB.filters.artists,renderArtists),UI.mobile&&$("#top-columns").animate({left:"-50%"},200),setLibMenuHeader()}),$("#albumsList").on("click",".lib-entry",function(e){var t=$("#albumsList .lib-entry").index(this);LIB.albumClicked=!0,UI.libPos[0]=t,UI.libPos[1]=filteredAlbumCovers.map(function(e){return e.album}).indexOf(filteredAlbums[t].album);var r=filteredAlbums[t],l=filteredAlbums[t].album;storeLibPos(UI.libPos),$("#albumsList .lib-entry").removeClass("active"),$("#albumsList .lib-entry").eq(t).addClass("active"),clickedLibItem(e,keyAlbum(r),LIB.filters.albums,renderSongs),$("#bottom-row").css("display","flex"),$("#lib-file").scrollTo(0,200),UI.libAlbum=l}),$("#random-album").click(function(e){var t=new Uint16Array(1);if(LIB.albumClicked=!0,window.crypto.getRandomValues(t),pos=Math.floor(t[0]/65535*filteredAlbums.length),"tag"==currentView){var r="#albumsList .lib-entry",l="albums";UI.libPos[0]=pos,UI.libPos[1]=filteredAlbumCovers.map(function(e){return e.album}).indexOf(filteredAlbums[pos].album);var i=filteredAlbums[pos]}else{var r="#albumcovers .lib-entry",l="albumcovers";UI.libPos[0]=filteredAlbums.map(function(e){return e.album}).indexOf(filteredAlbumCovers[pos].album),UI.libPos[1]=pos;var i=filteredAlbumCovers[pos]}storeLibPos(UI.libPos),$(r).removeClass("active"),$(r).eq(pos).addClass("active"),customScroll(l,pos,200),clickedLibItem(e,keyAlbum(i),LIB.filters.albums,renderSongs)}),$("#albumcovers").on("click",".cover-menu",function(e){var t=$(this).parents("li").index();LIB.albumClicked=!0,$("#albumcovers .lib-entry").eq(UI.libPos[1]).removeClass("active"),$("#tracklist-toggle").show(),UI.libPos[0]=filteredAlbums.map(function(e){return e.album}).indexOf(filteredAlbumCovers[t].album),UI.libPos[1]=t,storeLibPos(UI.libPos),$("#albumcovers .lib-entry").eq(UI.libPos[1]).addClass("active");var r=filteredAlbumCovers[t];clickedLibItem(e,keyAlbum(r),LIB.filters.albums,renderSongs)}),$("#albumcovers").on("click","img",function(e){var t=$(this).parents("li").index();LIB.albumClicked=!0,$("#albumcovers .lib-entry").eq(UI.libPos[1]).removeClass("active"),UI.libPos[0]=filteredAlbums.map(function(e){return e.album}).indexOf(filteredAlbumCovers[t].album),UI.libPos[1]=t,storeLibPos(UI.libPos),$("#albumcovers .lib-entry").eq(UI.libPos[1]).addClass("active");var r=filteredAlbumCovers[t];clickedLibItem(e,keyAlbum(r),LIB.filters.albums,renderSongs);var l=[];for(var i in filteredSongs)l.push(filteredSongs[i].file);if("No action"==SESSION.json.library_instant_play)return!1;var s="Add/Play"==SESSION.json.library_instant_play?"playall":"clrplayall";return mpdDbCmd(s,l),notify(s,""),!1}),$(".ralbum").click(function(e){$(".ralbum svg").attr("class","spin"),setTimeout(function(){$(".ralbum svg").attr("class","")},RALBUM_TIMEOUT);var t=new Uint16Array(1);LIB.albumClicked=!0,window.crypto.getRandomValues(t),pos=Math.floor(t[0]/65535*filteredAlbums.length),UI.libPos[0]=pos,UI.libPos[1]=filteredAlbumCovers.map(function(e){return e.album}).indexOf(filteredAlbums[pos].album);var r=filteredAlbums[pos];clickedLibItem(e,keyAlbum(r),LIB.filters.albums,renderSongs);var l=[];for(var i in filteredSongs)l.push(filteredSongs[i].file);if("Add/Play"==SESSION.json.library_instant_play||"No action"==SESSION.json.library_instant_play)mpdDbCmd("playall",l);else{var s=$(".playlist li").length;mpdDbCmd("addall",l),setTimeout(function(){1==s?cmd="delplitem&range=0":cmd="delplitem&range=0:"+s,$.get("command/moode.php?cmd="+cmd,function(){sendMpdCmd("play 0")})},CLRPLAY_TIMEOUT)}}),$("#database-radio").on("click","img",function(){if("No action"==SESSION.json.library_instant_play)return!1;var e=$(this).parents("li").index(),t=$(this).parents("li").data("path");if($(this).parents().hasClass("db-radiofolder-icon"))UI.raFolderLevel[UI.raFolderLevel[4]]=$(this).parents("li").attr("id").replace("db-",""),++UI.raFolderLevel[4],mpdDbCmd("lsinfo_radio",$(this).parents("li").data("path"));else{UI.radioPos=e,storeRadioPos(UI.radioPos);var r="Add/Play"==SESSION.json.library_instant_play?"play":"clrplay";mpdDbCmd(r,t),"play"!=r&&notify(r,""),setTimeout(function(){customScroll("radio",UI.radioPos,200)},SCROLLTO_TIMEOUT)}return!1}),$("#radio-manager-btn").click(function(){$("#import-export-msg").text(""),$("#radio-manager-modal").modal()}),$("#export-stations").click(function(e){$("#import-export-msg").text("Exporting..."),e.preventDefault(),$.post("command/moode.php?cmd=export_stations",function(){window.location.href="/imagesw/stations.zip",$("#import-export-msg").text("Export complete")})}),$("#database-radio").on("click",".db-entry",function(){if("No action"==SESSION.json.library_instant_play)return!1;var e=$(this).parents("li").index(),t=$(this).parents("li").data("path");UI.radioPos=e,storeRadioPos(UI.radioPos);var r="Add/Play"==SESSION.json.library_instant_play?"play":"clrplay";return mpdDbCmd(r,t),"play"!=r&&notify(r,""),setTimeout(function(){customScroll("radio",UI.radioPos,200)},SCROLLTO_TIMEOUT),!1}),$("#lib-coverart-img").click(function(){UI.dbEntry[0]=$.isNumeric(UI.dbEntry[0])?UI.dbEntry[0]:0,$("#songsList li, #songsList .lib-disc a").removeClass("active"),$("img.lib-coverart").addClass("active"),$("#tracklist-toggle").hide()}),$("#songsList").on("click",".lib-disc",function(){$("img.lib-coverart, #songsList li, #songsList .lib-disc a").removeClass("active");var e=$(this).text().substr(5);$("#lib-disc-"+e+" a").addClass("active"),filteredSongsDisc.length=0;for(var t in filteredSongs)filteredSongs[t].disc==e&&filteredSongsDisc.push(filteredSongs[t])}),$("#songsList").on("click",".lib-action",function(){UI.dbEntry[0]=$("#songsList .lib-action").index(this),$("#songsList li, #songsList .lib-disc a").removeClass("active"),$(this).parent().addClass("active"),$("img.lib-coverart").removeClass("active")}),$("#context-menu-playback a").click(function(){if("save-playlist"==$(this).data("cmd")&&$("#savepl-modal").modal(),"set-favorites"==$(this).data("cmd")&&$.getJSON("command/moode.php?cmd=getfavname",function(e){$("#pl-favName").val(e),$("#setfav-modal").modal()}),"toggle-song"==$(this).data("cmd")&&sendMpdCmd("playid "+toggleSongId),"consume"==$(this).data("cmd")){$("#menu-check-consume").toggle();var e=$(".consume").hasClass("btn-primary")?"0":"1";$(".consume").toggleClass("btn-primary"),sendMpdCmd("consume "+e)}if("repeat"==$(this).data("cmd")){$("#menu-check-repeat").toggle();var e=$(".repeat").hasClass("btn-primary")?"0":"1";$(".repeat").toggleClass("btn-primary"),sendMpdCmd("repeat "+e)}if("single"==$(this).data("cmd")){$("#menu-check-single").toggle();var e=$(".single").hasClass("btn-primary")?"0":"1";$(".single").toggleClass("btn-primary"),sendMpdCmd("single "+e)}}),$("#context-menu-lib-item a").click(function(){$("#lib-song-"+(UI.dbEntry[0]+1).toString()).removeClass("active"),$("img.lib-coverart").removeClass("active"),"add"==$(this).data("cmd")?(mpdDbCmd("add",filteredSongs[UI.dbEntry[0]].file),notify("add")):"play"==$(this).data("cmd")?mpdDbCmd("play",filteredSongs[UI.dbEntry[0]].file):"clrplay"==$(this).data("cmd")?(mpdDbCmd("clrplay",filteredSongs[UI.dbEntry[0]].file),notify("clrplay"),$("#pl-saveName").val("")):"track_info_lib"==$(this).data("cmd")&&$.post("command/moode.php?cmd=track_info",{path:filteredSongs[UI.dbEntry[0]].file},function(e){$("#track-info-text").html(e),$("#track-info-modal").modal()},"json")}),$("#context-menu-lib-all a").click(function(){UI.dbEntry[0]=$.isNumeric(UI.dbEntry[0])?UI.dbEntry[0]:0,$(".album-view-button").hasClass("active")||($("#lib-song-"+(UI.dbEntry[0]+1).toString()).removeClass("active"),$("img.lib-coverart").removeClass("active"));var e=[];for(var t in filteredSongs)e.push(filteredSongs[t].file);"addall"==$(this).data("cmd")?(mpdDbCmd("addall",e),notify("add")):"playall"==$(this).data("cmd")?(mpdDbCmd("playall",e),notify("add")):"clrplayall"==$(this).data("cmd")?(mpdDbCmd("clrplayall",e),notify("clrplay")):"tracklist"==$(this).data("cmd")&&("none"==$("#bottom-row").css("display")?($("#tracklist-toggle").html('<i class="fal fa-list sx"></i> Hide tracks'),$("#bottom-row").css("display","flex"),$("#lib-albumcover").css("height","calc(47% - 2em)"),$("#index-albumcovers").hide()):($("#tracklist-toggle").html('<i class="fal fa-list sx"></i> Show tracks'),$("#bottom-row").css("display",""),$("#lib-albumcover").css("height","100%"),$("#index-albumcovers").show()),customScroll("albumcovers",UI.libPos[1],200))}),$("#context-menu-lib-disc a").click(function(){$("#songsList .lib-disc a").removeClass("active");var e=[];for(var t in filteredSongsDisc)e.push(filteredSongsDisc[t].file);"addall"==$(this).data("cmd")&&(mpdDbCmd("addall",e),notify("add")),"playall"==$(this).data("cmd")&&(mpdDbCmd("playall",e),notify("add")),"clrplayall"==$(this).data("cmd")&&(mpdDbCmd("clrplayall",e),notify("clrplay"))});
